import {
    debugPrint;
    decodeUtf8;
    trap;
} "mo:prim";
import Prim "mo:prim";

import Blob "mo:core/Blob";
import Text "mo:core/Text";
import Array "mo:core/Array";
import Result "mo:core/Result";
import Hex "mo:hex";

// Import functionality from WASM components.
import meet_and_greet "component:meet_and_greet";
import ic_sig_verifier "component:ic_sig_verifier";
import { verifyBlsSig = verifyBlsSignature } "component:ic_sig_verifier";
import zstd "component:zstd";

var failed = 0;

func testBlobText(msg : Text, actual : Blob, expected : Text) {
    let ?actualText = decodeUtf8(actual) else trap("Failed to decode blob to text");
    test(msg, actualText, expected);
};

func test(msg : Text, actual : Text, expected : Text) {
    if (actual == expected) {
        debugPrint("‚úÖ " # msg # " " # actual);
    } else {
        failed += 1;
        debugPrint("‚ùå " # msg);
        debugPrint("Expected: " # expected);
        debugPrint("Actual  : " # actual);
    };
};

func v1(n : Nat) : meet_and_greet.V1 = switch (n) {
    case (0) #abc;
    case (1) #def;
    case (_) #gh;
};
func shortenText(s : Text) : Text {
    let chars = Text.toArray(s);
    let n = chars.size();
    let first4 = Array.sliceToArray<Char>(chars, 0, if (n < 4) n else 4);
    let last4 = Array.sliceToArray<Char>(chars, if (n < 4) 0 else n - 4, n);
    Text.fromArray(Array.flatten([first4, Text.toArray(".."), last4]));
};

func testBlsSignature(sig_hex : Text, msg_hex : Text, pk_hex : Text, expected : Result.Result<(), Text>) {
    let actual = verifyBlsSignature(
        Blob.fromArray(Hex.toArrayUnsafe(sig_hex)),
        Blob.fromArray(Hex.toArrayUnsafe(msg_hex)),
        Blob.fromArray(Hex.toArrayUnsafe(pk_hex))
    );
    let logMsg = "BLS sig: " # shortenText(sig_hex) # " for msg " # shortenText(msg_hex) # " and pk " # shortenText(pk_hex);
    if (actual == expected) {
        debugPrint("‚úÖ " # logMsg # " is " # (if (expected == (#ok)) { "valid" } else { "invalid" }) # ", as expected");
    } else {
        failed += 1;
        debugPrint("‚ùå verification of " # logMsg # " returned unexpected result:");
        debugPrint("   Expected: " # debug_show (expected));
        debugPrint("   Actual  : " # debug_show (actual));
    };
};

func testCanisterSignature(sig_hex : Text, msg_hex : Text, pk_hex : Text, root_pk_hex : Text, expected : Result.Result<(), Text>) {
    let actual = ic_sig_verifier.verifyCanisterSig(
        Blob.fromArray(Hex.toArrayUnsafe(sig_hex)),
        Blob.fromArray(Hex.toArrayUnsafe(msg_hex)),
        Blob.fromArray(Hex.toArrayUnsafe(pk_hex)),
        Blob.fromArray(Hex.toArrayUnsafe(root_pk_hex))
    );
    let logMsg = "Canister sig: " # shortenText(sig_hex) # " for msg " # shortenText(msg_hex) # " pk " # shortenText(pk_hex) # " and root pk " # shortenText(root_pk_hex);
    if (actual == expected) {
        debugPrint("‚úÖ " # logMsg # " is " # (if (expected == (#ok)) { "valid" } else { "invalid" }) # ", as expected");
    } else {
        failed += 1;
        debugPrint("‚ùå verification of " # logMsg # " returned unexpected result:");
        debugPrint("   Expected: " # debug_show (expected));
        debugPrint("   Actual  : " # debug_show (actual));
    };
};

do {
    debugPrint("\n===== Meet-and-greet basic functionality: ");

    test("sayHello: ", meet_and_greet.sayHello("Bob"), "Hello Bob!");
    test("sayBye, informal: ", meet_and_greet.sayBye("Alice", false), "Bye Alice!");
    test("sayBye, formal: ", meet_and_greet.sayBye("Carol", true), "Goodbye Carol!");
};

type CanisterSigVerifierArgs = {
    message : Blob;
    signature_cbor : Blob;
    public_key_der : Blob;
};

do {
    debugPrint("\n===== BLS signature verification: ");

    type TestBlsSignature = {
        expected : Result.Result<(), Text>;
        sig_hex : Text;
        msg_hex : Text;
        pk_hex : Text;
    };

    // Test vectors from https://github.com/dfinity/verify-bls-signatures/blob/master/tests/tests.rs
    let test_data_hex : [TestBlsSignature] = [
        {
            expected = (#ok);
            sig_hex = "ace9fcdd9bc977e05d6328f889dc4e7c99114c737a494653cb27a1f55c06f4555e0f160980af5ead098acc195010b2f7";
            msg_hex = "0d69632d73746174652d726f6f74e6c01e909b4923345ce5970962bcfe3004bfd8474a21dae28f50692502f46d90";
            pk_hex = "814c0e6ec71fab583b08bd81373c255c3c371b2e84863c98a4f1e08b74235d14fb5d9c0cd546d9685f913a0c0b2cc5341583bf4b4392e467db96d65b9bb4cb717112f8472e0d5a4d14505ffd7484b01291091c5f87b98883463f98091a0baaae";
        },
        {
            expected = (#ok);
            sig_hex = "89a2be21b5fa8ac9fab1527e041327ce899d7da971436a1f2165393947b4d942365bfe5488710e61a619ba48388a21b1";
            msg_hex = "0d69632d73746174652d726f6f74b294b418b11ebe5dd7dd1dcb099e4e0372b9a42aef7a7a37fb4f25667d705ea9";
            pk_hex = "9933e1f89e8a3c4d7fdcccdbd518089e2bd4d8180a261f18d9c247a52768ebce98dc7328a39814a8f911086a1dd50cbe015e2a53b7bf78b55288893daa15c346640e8831d72a12bdedd979d28470c34823b8d1c3f4795d9c3984a247132e94fe";
        },
        {
            expected = (#err("BLS signature verification failed"));
            sig_hex = "89a2be21b5fa8ac9fab1527e041327ce899d7da971436a1f2165393947b4d942365bfe5488710e61a619ba48388a21b1";
            msg_hex = "0d69632d73746174652d726f6f74e6c01e909b4923345ce5970962bcfe3004bfd8474a21dae28f50692502f46d90";
            pk_hex = "814c0e6ec71fab583b08bd81373c255c3c371b2e84863c98a4f1e08b74235d14fb5d9c0cd546d9685f913a0c0b2cc5341583bf4b4392e467db96d65b9bb4cb717112f8472e0d5a4d14505ffd7484b01291091c5f87b98883463f98091a0baaae";
        },
        {
            expected = (#err("BLS signature verification failed"));
            sig_hex = "ace9fcdd9bc977e05d6328f889dc4e7c99114c737a494653cb27a1f55c06f4555e0f160980af5ead098acc195010b2f7";
            msg_hex = "0d69632d73746174652d726f6f74b294b418b11ebe5dd7dd1dcb099e4e0372b9a42aef7a7a37fb4f25667d705ea9";
            pk_hex = "9933e1f89e8a3c4d7fdcccdbd518089e2bd4d8180a261f18d9c247a52768ebce98dc7328a39814a8f911086a1dd50cbe015e2a53b7bf78b55288893daa15c346640e8831d72a12bdedd979d28470c34823b8d1c3f4795d9c3984a247132e94fe";
        },
        {
            expected = (#err("BLS signature verification failed"));
            sig_hex = "ace9fcdd9bc977e05d6328f889dc4e7c99114c737a494653cb27a1f55c06f4555e0f160980af5ead098acc195010b2f8";
            msg_hex = "0d69632d73746174652d726f6f74e6c01e909b4923345ce5970962bcfe3004bfd8474a21dae28f50692502f46d90";
            pk_hex = "814c0e6ec71fab583b08bd81373c255c3c371b2e84863c98a4f1e08b74235d14fb5d9c0cd546d9685f913a0c0b2cc5341583bf4b4392e467db96d65b9bb4cb717112f8472e0d5a4d14505ffd7484b01291091c5f87b98883463f98091a0baaae";
        },
        {
            expected = (#err("BLS signature verification failed"));
            sig_hex = "ace9fcdd9bc977e05d6328f889dc4e7c99114c737a494653cb27a1f55c06f4555e0f160980af5ead098acc195010b2f7";
            msg_hex = "0d69632d73746174652d726f6f74e6c01e909b4923345ce5970962bcfe3004bfd8474a21dae28f50692502f46d90";
            pk_hex = "814c0e6ec71fab583b08bd81373c255c3c371b2e84863c98a4f1e08b74235d14fb5d9c0cd546d9685f913a0c0b2cc5341583bf4b4392e467db96d65b9bb4cb717112f8472e0d5a4d14505ffd7484b01291091c5f87b98883463f98091a0baaad";
        }
    ];
    for (tuple in test_data_hex.values()) {
        testBlsSignature(
            tuple.sig_hex,
            tuple.msg_hex,
            tuple.pk_hex,
            tuple.expected
        );
    };
};

do {

    debugPrint("\n===== Canister Signature verification: ");

    type TestCanisterSignature = {
        expected : Result.Result<(), Text>;
        sig_hex : Text;
        msg_hex : Text;
        pk_hex : Text;
        root_pk_hex : Text;
    };

    // Test vectors from tests of
    // https://github.com/dfinity/verifiable-credentials-sdk/tree/main/rust-packages/ic-verifiable-credentials
    let test_data_hex : [TestCanisterSignature] = [
        {
            expected = (#ok);
            msg_hex = "1a696363735f76657269666961626c655f63726564656e7469616c65794a71643273694f6e736961335235496a6f6962324e30496977695957786e496a6f6953574e4463794973496d73694f694a4e524864335245465a5330743357554a43515564456455564e516b466e54584e4251573942515546425155464251554642515556434d4764365454564a6558464d595568794d4468745154525764324a35536d527851544679525646555832784e516e5656626d4e355544565659794a394c434a72615751694f694a6b6157513661574e774f6e4a33624764304c576c70595746684c574668595746684c574668595746684c574e6861534973496d46735a794936496b6c6a51334d6966512e65794a6c654841694f6a45324d6a417a4d6a6b314d7a4173496d6c7a63794936496d68306448427a4f6938766157526c626e527064486b7561574d774c6d4677634338694c434a75596d59694f6a45324d6a417a4d6a67324d7a4173496d703061534936496d526864474536644756346443397762474670626a746a614746796332563050565655526930344c4852706257567a6447467463463975637a6f784e6a49774d7a49344e6a4d774d4441774d4441774d4441774c4746736157467a58326868633267364e546869597a63784d6d59794d6a46684f544a6d4d4745354f5452685a445a6d4e324a6d4f57566a4e6a63304d7a426d4d47466b4d7a4e6d5957566c5a44417a5a6d557a5a4455324e5459794d546c694d6a51324d694973496e4e3159694936496d52705a4470705933413663444a7562474d744d334d316457777462474e314e7a517464445a77626a497464576b3161573074615452684e575974595452305a3245745a545a36626d5974644735326247677464327474616e4d745a48466c49697769646d4d694f6e736951474e76626e526c654851694f694a6f64485277637a6f764c336433647935334d793576636d63764d6a41784f43396a636d566b5a57353061574673637939324d534973496e5235634755694f6c7369566d567961575a7059574a735a554e795a57526c626e5270595777694c434a4a626e526c636d356c64456c6b5a573530615852355357524262476c6863794a644c434a6a636d566b5a5735306157467355335669616d566a6443493665794a4a626e526c636d356c64456c6b5a573530615852355357524262476c686379493665794a6f59584e4a5a4546736157467a496a6f69616d74724d6a4974656e466b65474d74613264775a586f744e6e4e324d6d30744e5842696554517464326b306444497463484a74623345745a3259796157677461544a7864474d74646a4d3359574d744e57466c496e3139665830";
            sig_hex = "d9d9f7a26b63657274696669636174655901b1d9d9f7a2647472656583018301830183024863616e6973746572830183024a0000000000000000010183018301830183024e6365727469666965645f6461746182035820be52414d90e02b5ffd55bdfed7c7562887f2dbc5938d9d58a9d8c55960085fde82045820d2ccff3fcc5da930dec0e84a2541e658516b4bb1501e70e8b410e6986a057d6082045820fca6744d5aae6e8fc4196a0c50f037e41619e01e5946447fcc37cd2100b06b8e820458200f14a82f9bf38e11c3827add9a04617256a73268e3a5660be35faeb3a80453a9820458205c0cc25af6fd878aac56ce35214241001ce34aa019f0323317f821187a4698718204582045b137b0e6aa8bff642fe533d4a99ffe9096b7815245a1d4f4a2d21534f779c7820458204044487cdd5e1c15187d0af67cec88fe74ca1d2ef5baabbec0e01d630ab2517f8301820458203553f6581d53b3dd27646f61c8b0da0b0c3881b857c6dc3c47ea6888c113eb6b83024474696d6582034980b8aed4dd89a4be16697369676e61747572655830a6ffd47eaedf736c4d9e3ff59b0b216a3bbb713bceb035f052d65cb2249ea0c72d43d969f0e64368d9750a5019aef6ae6474726565830182045820e1a795cff7c973d356b109d69ddd297e47c6430ece2527a40d477978905b83bc83024373696783025820839047bc25dd6b3d25bf153f8ae121bdfb5ca2cc9246763fb59a679c1eeb4586830183025820dc348e292ddc73df5b749a858e239cb35dcf36919247cff9f9426c3f6dd4774282034082045820eb026546612db98f8b0a9ea279e11d77ab4ef3f1e572dec7f15ad6f431fb11a2";
            pk_hex = "303c300c060a2b0601040183b8430102032c000a00000000000000000101d20ccce48caa2da1ebd3c980e15c1bc8976a035ac4413fe5301b949dcc8fe547";
            root_pk_hex = "adf65638a53056b2222c91bb2457b0274bca95198a5acbdadfe7fd72178f069bdea8d99e9479d8087a2686fc81bf3c4b11fe275570d481f1698f79d468afe0e57acc1e298f8b69798da7a891bbec197093ec5f475909923d48bfed6843dbed1f";
        },
        {
            expected = (#err("invalid BLS signature"));
            msg_hex = "1a696363735f76657269666961626c655f63726564656e7469616c65794a71643273694f6e736961335235496a6f6962324e30496977695957786e496a6f6953574e4463794973496d73694f694a4e524864335245465a5330743357554a43515564456455564e516b466e54584e425157394251554642515546485155464b643056434d57524f63455a684d6a4e5953485669656e6332596c41334d55565462323079544646776355686d576a5668617a644f574752716546645651534a394c434a72615751694f694a6b6157513661574e774f6d5a6e644755314c574e70595746684c5746685957466b4c574668595852784c574e6861534973496d46735a794936496b6c6a51334d6966512e65794a6c654841694f6a45334d6a6b334e54677a4e546b73496d6c7a63794936496d68306448427a4f6938766157526c626e527064486b7561574d774c6d4677634338694c434a75596d59694f6a45334d6a6b334e5463304e546b73496d703061534936496d526864474536644756346443397762474670626a746a614746796332563050565655526930344c4852706257567a6447467463463975637a6f784e7a49354e7a55334e4455354d4451794f4451304e7a6b794c4746736157467a58326868633267365a4451344f5449774d3245774f474578593251304e325978593251794f57566b5a4445774f4464684e5449784f574a684d4463324e7a4d345a6d5577595755315957557a4f574e6a5a446c6d4d5446684e7a557a4d794973496e4e3159694936496d52705a447070593341364e32566962326b7464486c3165584d74595846744e474d74647a4a734e326b74646d64315932307465485a686433677462475674656e67744e6d74784d6d63745a6a557a6454637465585a6d61444974626d466c49697769646d4d694f6e736951474e76626e526c654851694f694a6f64485277637a6f764c336433647935334d793576636d63764d6a41784f43396a636d566b5a57353061574673637939324d534973496e5235634755694f6c7369566d567961575a7059574a735a554e795a57526c626e5270595777694c434a4a626e526c636d356c64456c6b5a573530615852355357524262476c6863794a644c434a6a636d566b5a5735306157467355335669616d566a6443493665794a4a626e526c636d356c64456c6b5a573530615852355357524262476c686379493665794a6f59584e4a5a4546736157467a496a6f69656d6f335a6d6774616a4e6a5a3359745a5739715a48497461445531614745744e4738324e3349744d7a4a31644855744d6a4a70646a4974627a646f61486b744d336c76623351746547526a636d59744e58466c496977695a47567961585a6864476c76626b39796157647062694936496d68306448427a4f6938766244647964574574636d46685957457459574668595841745957686f4e6d4574593246704c6d6c6a4d43356863484169665831396651";
            sig_hex = "d9d9f7a26b636572746966696361746559056dd9d9f7a3647472656583018301830182045820a65afa38e224228863a89ebb73cfe55cf9c0b5e6c8f8756c3988cd7839765e8b83024863616e69737465728301830183018301830183018204582002104c8e2dbc34602f9a217d40c565390df7dcb179470549910f34850c2992158301820458204042fb2844db206e1724a248eef393f5cb1d22280f298d948fc18e0a408533438301820458208d3dbc5b1ac807eb4f313b91712db94fdf4a50068207719f1cba37771b2ac8ef83024a000000000060002701018301830183024e6365727469666965645f64617461820358202bde1ed38da26d645c0836ad80dabb15b7d0be693a93f8049ee2d11d592da1a5820458206ccd6bb31a54761d4a56e9cfd8cba384d5b8fb47184e8ca13cb70e04f2209ace8204582027141750bb35750bc761ac1d60cc6a2d4986403f01d5dbbe85af1786011f04f4820458203de781de0811f5a8469166c594f9433d966f686f4f4065ad9395e30bfac153e282045820cb2a94057004ae336fb52ba39117cf90aaadefe02ddfe9205bcc13c8f6150a0282045820bc1f9b4c54f66eb8fc25381e90641ae59ef87c590186355162a52cb4875242cb820458206fcca1646dd232030af759bddcb55584b59b23ef29dc154280e6ed0011a3087782045820f7faed516539ed96ea3a18ee856fcae4f78f00e92a6d2b03f2a0bcc8d6328cfe820458202407f9442c8a67a79e4692427d228223ae53308c0b1c724af32397541357b3f2830182045820d2345604038a7a430400775f0d73a269db96e46829a665e3077d3b87fe241d9e83024474696d65820349f880d3eee8a7d58018697369676e6174757265583092e7bc06e4f5e033510fb315fbe99f58516483f7c58d7f3eb93676416685c69b20456b3142152f65edd4f6eb4da73b2e6a64656c65676174696f6ea2697375626e65745f6964581d2c55b347ecf2686c83781d6c59d1b43e7b4cba8deb6c1b376107f2cd026b6365727469666963617465590294d9d9f7a26474726565830182045820c9fbb9bc66549fab9fb9e3e940bbb88652a6377d0d9219424054aa47cb9a352083018301820458205896bd1eeaf3ea3ce120ccd23550ba2fc5a1797f49aa22bd24664d20180de68f8302467375626e65748301830183018301820458208739fbbedd3dedaa8fef41870367c0905bde376b63dd37e2b176fb08b582052f83018204582083f23467f55e3b289c9ec6ca39fe9c02ef65bd1e6ed5c11866c2aabe76beaa7683018302581d2c55b347ecf2686c83781d6c59d1b43e7b4cba8deb6c1b376107f2cd02830183024f63616e69737465725f72616e67657382035832d9d9f782824a000000000060000001014a00000000006000ae0101824a00000000006000b001014a00000000006fffff010183024a7075626c69635f6b657982035885308182301d060d2b0601040182dc7c0503010201060c2b0601040182dc7c0503020103610090075120778eb21a530a02bcc763e7f4a192933506966af7b54c10a4d2b24de6a86b200e3440bae6267bf4c488d9a11d0472c38c1b6221198f98e4e6882ba38a5a4e3aa5afce899b7f825ed95adfa12629688073556f2747527213e8d73e40ce8204582036f3cd257d90fb38e42597f193a5e031dbd585b6292793bb04db4794803ce06e8204582088fea0db69f38f9cf3fba88f8a040f3cadc9ae7772fa1a406a6ea464fa858b9e820458206961ef137c2aee0b0467082ef6d3c12c03e93013b602a4cb6214270e484863f1820458207e1761253c8aaedee1ed43d88bb5bda630c0f1f89e740a6bcf11919f1e0d1f0b83024474696d65820349c3bbcfd1e9f19b8018697369676e61747572655830949fb2ecdfd08b2e1960646673a4cf15c58491e0df499182a2cd33140b81c2abca0150b98836891e0179cc008dadf966647472656583018204582063f543465ce3b3ec0d45d19d38700ad907dbb7aa8288cb99d15c4b936bdf6f388302437369678301820458200c6e05e73fc1523c155851c2f56ef6ed1c46202d4173bef870f9047e516e94bf83025820f3e3c7481e7933f4fc975aa602d65065450482153edadad2695a03166ef30ea08301830258203d632e230b5792dd34b2d42d6ddac7f7abaf4a73ea22495217bcb813008aacdd82034082045820e210f850c7f5c0ad5ab7bb931365bc02b33b2369eafca69153e0b09cf197abde";
            pk_hex = "303c300c060a2b0601040183b8430102032c000a00000000006000270101d5d36915adb75c7b9bcf0e9b3fbd444a89b62d0a6a1df6796a4ecd5dd8f15940";
            root_pk_hex = "adf65638a53056b2222c91bb2457b0274bca95198a5acbdadfe7fd72178f069bdea8d99e9479d8087a2686fc81bf3c4b11fe275570d481f1698f79d468afe0e57acc1e298f8b69798da7a891bbec197093ec5f475909923d48bfed6843dbed1f";
        },
        {
            expected = (#ok);
            msg_hex = "1a696363735f76657269666961626c655f63726564656e7469616c65794a71643273694f6e736961335235496a6f6962324e30496977695957786e496a6f6953574e4463794973496d73694f694a4e524864335245465a5330743357554a43515564456455564e516b466e54584e42515739425155464251554642515546425555564365556b33646c45794f4756796248466e566a564d636b303364544e494f556c61654756776355787a516b646e536a4679546c64615830746651534a394c434a72615751694f694a6b6157513661574e774f6e4a796132466f4c575a78595746684c574668595746684c574668595746784c574e6861534973496d46735a794936496b6c6a51334d6966512e65794a7063334d694f694a6f64485277637a6f764c325674634778766557316c626e51756157356d627938694c434a75596d59694f6a45324d6a417a4d6a67324d7a4173496d703061534936496d68306448427a4f6938765a573177624739356257567564433570626d5a764c324e795a57526c626e52705957787a4c7a51794969776963335669496a6f695a476c6b4f6d6c6a6344703261474a70596931744e4768744e69316f63485a355979303363484a6b4d69317a61576c3262793175596d5133636930324e323831654331754d324633614331786332317865693133656d35715a693130635755694c434a325979493665794a41593239756447563464434936496d68306448427a4f693876643364334c6e637a4c6d39795a7938794d4445344c324e795a57526c626e52705957787a4c3359784969776964486c775a53493657794a575a584a705a6d6c68596d786c51334a6c5a47567564476c6862434973496c5a6c636d6c6d6157566b52573177624739355a5755695853776959334a6c5a47567564476c6862464e31596d706c593351694f6e73695a573177624739355a575666623259694f6e73695a573177624739355a584a4a5a434936496d52705a4470335a5749365a475a70626d6c3065533576636d63694c434a6c6258427362336c6c636b3568625755694f694a45526b6c4f5356525a49455a766457356b5958527062323469665831396651";
            sig_hex = "d9d9f7a26b63657274696669636174655901b1d9d9f7a2647472656583018301830183024863616e6973746572830182045820abb0ebb8648af63d27369558960904e0eb5830759fc73aea0740feb53a7beee983024a0000000000000001010183018301830183024e6365727469666965645f646174618203582073ccb42b72ca6cd9ec8b10d3836531e75bf0bba6fd2aa9b6345ca4b8756d774e82045820d2ccff3fcc5da930dec0e84a2541e658516b4bb1501e70e8b410e6986a057d60820458204f0034339f3f2c5012cd92e4d63bbace1c10eaacde0d266c63273c024f96586082045820edb3ec7a95adc00373fde176a4168c3b2f9af941158fca2374c446871c88383a8204582011f95c041cc9ce8b81f46a00ab23098a27b1553d70ecb22fef609b724035e7e48204582016dc31485828b77dc0d8180f15708e4e3f6033c6743910e7f980f5b58356db098301820458203553f6581d53b3dd27646f61c8b0da0b0c3881b857c6dc3c47ea6888c113eb6b83024474696d6582034980b8aed4dd89a4be16697369676e61747572655830a2b32d258c3c30b8f3b1267ef663caaac60c434603f4b2b28fbc590483280d7d51e81069f0b1e30174c32b633212b6b364747265658301820458200bd064d3f94d140757b01abd3da33463cf2dc401cdf42fbdae611326c7bdbc3c8302437369678302582071995b8cb4904d68abaa066248578f7ea1d6c34f986da3c055fab4f1a24647d7830258202b25c84712003b469562ca301b012409577bc7a7e1e182b84f72b809eea9104e820340";
            pk_hex = "303c300c060a2b0601040183b8430102032c000a00000000000000010101c88eef436f1eae5aa05792eb33bbb71fd219c5ea6a2ec046809d6b35667f2bf0";
            root_pk_hex = "adf65638a53056b2222c91bb2457b0274bca95198a5acbdadfe7fd72178f069bdea8d99e9479d8087a2686fc81bf3c4b11fe275570d481f1698f79d468afe0e57acc1e298f8b69798da7a891bbec197093ec5f475909923d48bfed6843dbed1f";
        },
        {
            expected = (#ok);
            msg_hex = "1a696363735f76657269666961626c655f63726564656e7469616c65794a71643273694f6e736961335235496a6f6962324e30496977695957786e496a6f6953574e4463794973496d73694f694a4e524864335245465a5330743357554a43515564456455564e516b466e54584e425157394251554642515546485155464b643056434d57524f63455a684d6a4e5953485669656e6332596c41334d55565462323079544646776355686d576a5668617a644f574752716546645651534a394c434a72615751694f694a6b6157513661574e774f6d5a6e644755314c574e70595746684c5746685957466b4c574668595852784c574e6861534973496d46735a794936496b6c6a51334d6966512e65794a6c654841694f6a45334d6a6b334e54677a4e546b73496d6c7a63794936496d68306448427a4f6938766157526c626e527064486b7561574d774c6d4677634338694c434a75596d59694f6a45334d6a6b334e5463304e546b73496d703061534936496d526864474536644756346443397762474670626a746a614746796332563050565655526930344c4852706257567a6447467463463975637a6f784e7a49354e7a55334e4455354d4451794f4451304e7a6b794c4746736157467a58326868633267365a4451344f5449774d3245774f474578593251304e325978593251794f57566b5a4445774f4464684e5449784f574a684d4463324e7a4d345a6d5577595755315957557a4f574e6a5a446c6d4d5446684e7a557a4d794973496e4e3159694936496d52705a447070593341364e32566962326b7464486c3165584d74595846744e474d74647a4a734e326b74646d64315932307465485a686433677462475674656e67744e6d74784d6d63745a6a557a6454637465585a6d61444974626d466c49697769646d4d694f6e736951474e76626e526c654851694f694a6f64485277637a6f764c336433647935334d793576636d63764d6a41784f43396a636d566b5a57353061574673637939324d534973496e5235634755694f6c7369566d567961575a7059574a735a554e795a57526c626e5270595777694c434a4a626e526c636d356c64456c6b5a573530615852355357524262476c6863794a644c434a6a636d566b5a5735306157467355335669616d566a6443493665794a4a626e526c636d356c64456c6b5a573530615852355357524262476c686379493665794a6f59584e4a5a4546736157467a496a6f69656d6f335a6d6774616a4e6a5a3359745a5739715a48497461445531614745744e4738324e3349744d7a4a31644855744d6a4a70646a4974627a646f61486b744d336c76623351746547526a636d59744e58466c496977695a47567961585a6864476c76626b39796157647062694936496d68306448427a4f6938766244647964574574636d46685957457459574668595841745957686f4e6d4574593246704c6d6c6a4d43356863484169665831396651";
            sig_hex = "d9d9f7a26b636572746966696361746559056dd9d9f7a3647472656583018301830182045820a65afa38e224228863a89ebb73cfe55cf9c0b5e6c8f8756c3988cd7839765e8b83024863616e69737465728301830183018301830183018204582002104c8e2dbc34602f9a217d40c565390df7dcb179470549910f34850c2992158301820458204042fb2844db206e1724a248eef393f5cb1d22280f298d948fc18e0a408533438301820458208d3dbc5b1ac807eb4f313b91712db94fdf4a50068207719f1cba37771b2ac8ef83024a000000000060002701018301830183024e6365727469666965645f64617461820358202bde1ed38da26d645c0836ad80dabb15b7d0be693a93f8049ee2d11d592da1a5820458206ccd6bb31a54761d4a56e9cfd8cba384d5b8fb47184e8ca13cb70e04f2209ace8204582027141750bb35750bc761ac1d60cc6a2d4986403f01d5dbbe85af1786011f04f4820458203de781de0811f5a8469166c594f9433d966f686f4f4065ad9395e30bfac153e282045820cb2a94057004ae336fb52ba39117cf90aaadefe02ddfe9205bcc13c8f6150a0282045820bc1f9b4c54f66eb8fc25381e90641ae59ef87c590186355162a52cb4875242cb820458206fcca1646dd232030af759bddcb55584b59b23ef29dc154280e6ed0011a3087782045820f7faed516539ed96ea3a18ee856fcae4f78f00e92a6d2b03f2a0bcc8d6328cfe820458202407f9442c8a67a79e4692427d228223ae53308c0b1c724af32397541357b3f2830182045820d2345604038a7a430400775f0d73a269db96e46829a665e3077d3b87fe241d9e83024474696d65820349f880d3eee8a7d58018697369676e6174757265583092e7bc06e4f5e033510fb315fbe99f58516483f7c58d7f3eb93676416685c69b20456b3142152f65edd4f6eb4da73b2e6a64656c65676174696f6ea2697375626e65745f6964581d2c55b347ecf2686c83781d6c59d1b43e7b4cba8deb6c1b376107f2cd026b6365727469666963617465590294d9d9f7a26474726565830182045820c9fbb9bc66549fab9fb9e3e940bbb88652a6377d0d9219424054aa47cb9a352083018301820458205896bd1eeaf3ea3ce120ccd23550ba2fc5a1797f49aa22bd24664d20180de68f8302467375626e65748301830183018301820458208739fbbedd3dedaa8fef41870367c0905bde376b63dd37e2b176fb08b582052f83018204582083f23467f55e3b289c9ec6ca39fe9c02ef65bd1e6ed5c11866c2aabe76beaa7683018302581d2c55b347ecf2686c83781d6c59d1b43e7b4cba8deb6c1b376107f2cd02830183024f63616e69737465725f72616e67657382035832d9d9f782824a000000000060000001014a00000000006000ae0101824a00000000006000b001014a00000000006fffff010183024a7075626c69635f6b657982035885308182301d060d2b0601040182dc7c0503010201060c2b0601040182dc7c0503020103610090075120778eb21a530a02bcc763e7f4a192933506966af7b54c10a4d2b24de6a86b200e3440bae6267bf4c488d9a11d0472c38c1b6221198f98e4e6882ba38a5a4e3aa5afce899b7f825ed95adfa12629688073556f2747527213e8d73e40ce8204582036f3cd257d90fb38e42597f193a5e031dbd585b6292793bb04db4794803ce06e8204582088fea0db69f38f9cf3fba88f8a040f3cadc9ae7772fa1a406a6ea464fa858b9e820458206961ef137c2aee0b0467082ef6d3c12c03e93013b602a4cb6214270e484863f1820458207e1761253c8aaedee1ed43d88bb5bda630c0f1f89e740a6bcf11919f1e0d1f0b83024474696d65820349c3bbcfd1e9f19b8018697369676e61747572655830949fb2ecdfd08b2e1960646673a4cf15c58491e0df499182a2cd33140b81c2abca0150b98836891e0179cc008dadf966647472656583018204582063f543465ce3b3ec0d45d19d38700ad907dbb7aa8288cb99d15c4b936bdf6f388302437369678301820458200c6e05e73fc1523c155851c2f56ef6ed1c46202d4173bef870f9047e516e94bf83025820f3e3c7481e7933f4fc975aa602d65065450482153edadad2695a03166ef30ea08301830258203d632e230b5792dd34b2d42d6ddac7f7abaf4a73ea22495217bcb813008aacdd82034082045820e210f850c7f5c0ad5ab7bb931365bc02b33b2369eafca69153e0b09cf197abde";
            pk_hex = "303c300c060a2b0601040183b8430102032c000a00000000006000270101d5d36915adb75c7b9bcf0e9b3fbd444a89b62d0a6a1df6796a4ecd5dd8f15940";
            root_pk_hex = "814c0e6ec71fab583b08bd81373c255c3c371b2e84863c98a4f1e08b74235d14fb5d9c0cd546d9685f913a0c0b2cc5341583bf4b4392e467db96d65b9bb4cb717112f8472e0d5a4d14505ffd7484b01291091c5f87b98883463f98091a0baaae";
        },
        {
            expected = (#ok);
            msg_hex = "1a696363735f76657269666961626c655f63726564656e7469616c65794a71643273694f6e736961335235496a6f6962324e30496977695957786e496a6f6953574e4463794973496d73694f694a4e524864335245465a5330743357554a43515564456455564e516b466e54584e425157394251554642515546485155464b64305643587a464251326c6c655455776430566b5a45525462556b77635539574c58525a52314a5061486f31544642794d6e5231656d3477536d4a5061794a394c434a72615751694f694a6b6157513661574e774f6d5a6e644755314c574e70595746684c5746685957466b4c574668595852784c574e6861534973496d46735a794936496b6c6a51334d6966512e65794a6c654841694f6a45334d6a6b334e5467304d546373496d6c7a63794936496d68306448427a4f6938766157526c626e527064486b7561574d774c6d4677634338694c434a75596d59694f6a45334d6a6b334e5463314d546373496d703061534936496d526864474536644756346443397762474670626a746a614746796332563050565655526930344c4852706257567a6447467463463975637a6f784e7a49354e7a55334e5445334d6a59794d4459794d7a41314c4746736157467a58326868633267365a4759345a6a6b774f546b304e4751314d6a68684d5751324f4459774f5446695a544d35595751774e7a55794d6a457a59574a684d5751304d4459325a574a6a5a4467335a444e6c4e6d4d7a596d566b4f546c6b5a434973496e4e3159694936496d52705a447070593341364e32566962326b7464486c3165584d74595846744e474d74647a4a734e326b74646d64315932307465485a686433677462475674656e67744e6d74784d6d63745a6a557a6454637465585a6d61444974626d466c49697769646d4d694f6e736951474e76626e526c654851694f694a6f64485277637a6f764c336433647935334d793576636d63764d6a41784f43396a636d566b5a57353061574673637939324d534973496e5235634755694f6c7369566d567961575a7059574a735a554e795a57526c626e5270595777694c434a4a626e526c636d356c64456c6b5a573530615852355357524262476c6863794a644c434a6a636d566b5a5735306157467355335669616d566a6443493665794a4a626e526c636d356c64456c6b5a573530615852355357524262476c686379493665794a6b5a584a70646d46306157397554334a705a326c75496a6f696148523063484d364c7939734e334a315953317959574668595331685957466863433168614767325953316a59576b7561574d774c6d467763434973496d686863306c6b5157787059584d694f69493361584a33627931794e5851795a6930304e54527a6543317461336c746569316c64334a7a5a7931764e6d3969595331766244567164793079643342756379313562336877615330316457566e6279313263575569665831396651";
            sig_hex = "d9d9f7a26b636572746966696361746559056dd9d9f7a3647472656583018301830182045820a65afa38e224228863a89ebb73cfe55cf9c0b5e6c8f8756c3988cd7839765e8b83024863616e69737465728301830183018301830183018204582002104c8e2dbc34602f9a217d40c565390df7dcb179470549910f34850c2992158301820458204042fb2844db206e1724a248eef393f5cb1d22280f298d948fc18e0a408533438301820458208d3dbc5b1ac807eb4f313b91712db94fdf4a50068207719f1cba37771b2ac8ef83024a000000000060002701018301830183024e6365727469666965645f6461746182035820f8c2565903546af603a1fcf0aafabeccd8a65e67ad51ca81fb0d0bacd0bfb187820458206ccd6bb31a54761d4a56e9cfd8cba384d5b8fb47184e8ca13cb70e04f2209ace8204582027141750bb35750bc761ac1d60cc6a2d4986403f01d5dbbe85af1786011f04f4820458203de781de0811f5a8469166c594f9433d966f686f4f4065ad9395e30bfac153e282045820cb2a94057004ae336fb52ba39117cf90aaadefe02ddfe9205bcc13c8f6150a0282045820bc1f9b4c54f66eb8fc25381e90641ae59ef87c590186355162a52cb4875242cb820458206fcca1646dd232030af759bddcb55584b59b23ef29dc154280e6ed0011a3087782045820f7faed516539ed96ea3a18ee856fcae4f78f00e92a6d2b03f2a0bcc8d6328cfe82045820f29cbfbd1cccf419b6ec5e88c97cd62625ea5c3619f237c84eeed7b1a09f2e5d8301820458205715c18f10bf65d5acd6107168f997ee597ab43dfcb4f0b0fea6cdc48cb990f983024474696d65820349a7b7a0a7c3a9d58018697369676e6174757265583091d411e1044465b3f59ac6050b85eba12e836ce5b6c50f0ed08b28881aec5169406545f029f2ef75b1e55ba5592825836a64656c65676174696f6ea2697375626e65745f6964581d2c55b347ecf2686c83781d6c59d1b43e7b4cba8deb6c1b376107f2cd026b6365727469666963617465590294d9d9f7a26474726565830182045820c9fbb9bc66549fab9fb9e3e940bbb88652a6377d0d9219424054aa47cb9a352083018301820458205896bd1eeaf3ea3ce120ccd23550ba2fc5a1797f49aa22bd24664d20180de68f8302467375626e65748301830183018301820458208739fbbedd3dedaa8fef41870367c0905bde376b63dd37e2b176fb08b582052f83018204582083f23467f55e3b289c9ec6ca39fe9c02ef65bd1e6ed5c11866c2aabe76beaa7683018302581d2c55b347ecf2686c83781d6c59d1b43e7b4cba8deb6c1b376107f2cd02830183024f63616e69737465725f72616e67657382035832d9d9f782824a000000000060000001014a00000000006000ae0101824a00000000006000b001014a00000000006fffff010183024a7075626c69635f6b657982035885308182301d060d2b0601040182dc7c0503010201060c2b0601040182dc7c0503020103610090075120778eb21a530a02bcc763e7f4a192933506966af7b54c10a4d2b24de6a86b200e3440bae6267bf4c488d9a11d0472c38c1b6221198f98e4e6882ba38a5a4e3aa5afce899b7f825ed95adfa12629688073556f2747527213e8d73e40ce8204582036f3cd257d90fb38e42597f193a5e031dbd585b6292793bb04db4794803ce06e8204582088fea0db69f38f9cf3fba88f8a040f3cadc9ae7772fa1a406a6ea464fa858b9e820458206961ef137c2aee0b0467082ef6d3c12c03e93013b602a4cb6214270e484863f1820458207e1761253c8aaedee1ed43d88bb5bda630c0f1f89e740a6bcf11919f1e0d1f0b83024474696d65820349c3bbcfd1e9f19b8018697369676e61747572655830949fb2ecdfd08b2e1960646673a4cf15c58491e0df499182a2cd33140b81c2abca0150b98836891e0179cc008dadf966647472656583018204582063f543465ce3b3ec0d45d19d38700ad907dbb7aa8288cb99d15c4b936bdf6f388302437369678301820458203d5070496c73abf84d49425972f62146402b1360bc9df650f7402a9ca894459d830183025820db9233b2e97d1da50b0072d1bdecb7cf0aec562a775dd0dee2bf62c1f9820bbb8301830258203e8951d29080b4446ef377ef22ecc894bba17d0f1fe4ce40218e3ddb28b240598203408204582078b10771486afccfd002c865c2abb884d77f5bbb9b00ac96b513366dca2b67e28204582065516b7201e94b8f1167e1ead08b8f454484715799cdc1cd3404345e6e1066ef";
            pk_hex = "303c300c060a2b0601040183b8430102032c000a00000000006000270101ff500289ecb9d3011d7434a6234a8e57eb581913a1cf92cfaf6b6ece7d096ce9";
            root_pk_hex = "814c0e6ec71fab583b08bd81373c255c3c371b2e84863c98a4f1e08b74235d14fb5d9c0cd546d9685f913a0c0b2cc5341583bf4b4392e467db96d65b9bb4cb717112f8472e0d5a4d14505ffd7484b01291091c5f87b98883463f98091a0baaae";
        }
    ];
    for (tuple in test_data_hex.values()) {
        testCanisterSignature(
            tuple.sig_hex,
            tuple.msg_hex,
            tuple.pk_hex,
            tuple.root_pk_hex,
            tuple.expected
        );
    };
};

do {
    debugPrint("\n===== Error reported by a component: ");
    test("verifyCanisterSigMainnet: ", debug_show (ic_sig_verifier.verifyCanisterSigMainnet("args, serialized")), debug_show (#err("failed parsing arguments of verify_canister_sig")));
    let dummyArgs : CanisterSigVerifierArgs = {
        message = Blob.fromArray([1, 2, 3]); // Placeholder for message
        signature_cbor = Blob.fromArray([3, 4, 5]); // Placeholder for signature
        public_key_der = Blob.fromArray([6, 7, 8]); // Placeholder for public key
    };
    test("verifyCanisterSigMainnet: ", debug_show (ic_sig_verifier.verifyCanisterSigMainnet(to_candid (dummyArgs))), debug_show (#err("signature CBOR doesn't have a self-describing tag")));
};

func testCompression(data : Blob) {
    switch (zstd.encodeAll(data, 5)) {
        case (#ok(compressed)) {
            if (Blob.size(data) <= Blob.size(compressed)) {
                failed += 1;
                debugPrint("‚ùå Compression did not shrink the data: len(original)=" # debug_show (Blob.size(data)) # ", len(compressed)=" # debug_show (Blob.size(compressed)) # ".");
            } else {
                switch (zstd.decodeAll(compressed)) {
                    case (#ok(decompressed)) {
                        if (decompressed == data) {
                            debugPrint("‚úÖ Compression round-trip successful for data of length " # debug_show (Blob.size(data)) # ", compressed to length " # debug_show (Blob.size(compressed)) # ".");
                        } else {
                            failed += 1;
                            debugPrint("‚ùå Decompressed data does not match original!");
                        };
                    };
                    case (#err(errMsg)) {
                        failed += 1;
                        debugPrint("‚ùå Decompression failed: " # errMsg);
                    };
                };
            };
        };
        case (#err(errMsg)) {
            failed += 1;
            debugPrint("‚ùå Compression failed: " # errMsg);
        };
    };
};

do {
    debugPrint("\n===== Data compression using zstd");
    func repeat(s : Text, n : Nat) : Blob {
        var acc = "";
        var i : Nat = 0;
        while (i < n) {
            acc := acc # s;
            i += 1;
        };
        Text.encodeUtf8(acc);
    };
    testCompression(repeat("Hello, world! This is a test of zstd compression.", 2));
    testCompression("aaaaaaabbbbbbbccccccdddddddeeeeeeefffffffggggghhhhhhhiiiiiiiijjjjjjjkkkkkkkllllllllmmmmmmnnnnnno");
    testCompression(repeat("The quick brown fox jumps over the lazy dog. ", 100));
};

do {
    debugPrint("\n===== Various primitive types in arguments and the return value: ");

    testBlobText("Concat0: ", meet_and_greet.concat0(), "concat0");
    testBlobText("Concat2: ", meet_and_greet.concat2("Hello", "World"), "concat2: Hello World");
    test("Prim Bool", debug_show meet_and_greet.prim_bool(true), "true");
    test("Prim Bool", debug_show meet_and_greet.prim_bool(false), "false");
    test("Prim Char", debug_show meet_and_greet.prim_char('a'), "'a'");
    test("Prim U8", debug_show meet_and_greet.prim_u8(123), "123");
    test("Prim U16", debug_show meet_and_greet.prim_u16(12345), "12_345");
    test("Prim U32", debug_show meet_and_greet.prim_u32(1234567890), "1_234_567_890");
    test("Prim U64", debug_show meet_and_greet.prim_u64(12345678901234567890), "12_345_678_901_234_567_890");
    test("Prim I8", debug_show meet_and_greet.prim_i8(-125), "-125");
    test("Prim I16", debug_show meet_and_greet.prim_i16(-12349), "-12_349");
    test("Prim I32", debug_show meet_and_greet.prim_i32(-1234567893), "-1_234_567_893");
    test("Prim I64", debug_show meet_and_greet.prim_i64(-1234567890123456789), "-1_234_567_890_123_456_789");
    test("Prim F64", debug_show meet_and_greet.prim_f64(1234567890.123457), "1234567890.123457");
    test("Prim Text In", debug_show meet_and_greet.prim_text_in("Hello; emoji: ‚òÉ‚ùÑüå®; FooB√§r‚òÉ"), "+36");
    test("Prim Text Out", meet_and_greet.prim_text_out(), "Hello; emoji: ‚òÉ‚ùÑüå®; FooB√§r‚òÉ!");
    test("Prim Text", meet_and_greet.prim_text("Hello; emoji: ‚òÉ‚ùÑüå®; FooB√§r‚òÉ"), "Hello; emoji: ‚òÉ‚ùÑüå®; FooB√§r‚òÉ!");
    test("Vec U16", meet_and_greet.vec_u16([1, 2, 3]), "vec_u16: 1, 2, 3");
    test("Vec Text", meet_and_greet.vec_text(["Hello", "World"]), "vec_string: Hello, World");
    test("Vec I8", meet_and_greet.vec_i8([1, 2, 3, 4]), "vec_i8: 1, 2, 3, 4");
    test("Vec U8 As Blob", meet_and_greet.vec_u8_as_blob(Prim.arrayToBlob([1, 2, 3, 4])), "vec_u8_as_blob: 1, 2, 3, 4");
    test("Vec U32", meet_and_greet.vec_u32([10, 20, 30]), "vec_u32: 10, 20, 30");
    test("Vec I32", meet_and_greet.vec_i32([-1, -2, 3]), "vec_i32: -1, -2, 3");
    test("Vec I64", meet_and_greet.vec_i64([-1, -2, 3]), "vec_i64: -1, -2, 3"); // TODO
    test("Vec Bool", meet_and_greet.vec_bool([true, false, true]), "vec_bool: true, false, true");
    test("Vec Text Nested", meet_and_greet.vec_text_nested([["A", "B"], ["C"]]), "vec_string_nested: A|B; C");
    test("Vec Char", meet_and_greet.vec_char(['a', 'b', 'c']), "vec_char: abc");
    test("Vec F64", meet_and_greet.vec_f64([1.25, -2.5, 3.0]), "vec_f64: 1.25, -2.5, 3");

    test("To Vec Bool", debug_show meet_and_greet.to_vec_bool(1, true), "[true, false, true, false]");
    test("To Vec Char", debug_show meet_and_greet.to_vec_char(128, 'a'), "['@', 'a']");
    test("To Vec I8", debug_show meet_and_greet.to_vec_i8(2, 'a'), "[+1, +97]");
    test("To Vec U8 As Blob", debug_show Prim.blobToArray(meet_and_greet.to_vec_u8_as_blob(2, 'a')), "[1, 97]");
    test("To Vec I16", debug_show meet_and_greet.to_vec_i16(4, 1), "[+2, 0]");
    test("To Vec U32", debug_show meet_and_greet.to_vec_u32(8, 4), "[4, 2]");
    test("To Vec I64", debug_show meet_and_greet.to_vec_i64(4, 1), "[+2, 0]");
    test("To Vec F64", debug_show meet_and_greet.to_vec_f64(4, 1.4), "[2.000000, 0.700000]");
    test("To Vec String", debug_show meet_and_greet.to_vec_string("Hello", "World"), "[\"Hello!\", \"World!\"]");
    test("To Vec Vec Simple", debug_show meet_and_greet.to_vec_vec_simple(), "[[0, 0], [1, 1]]");
    test("To Vec Vec U64", debug_show meet_and_greet.to_vec_vec_u64(1), "[[1, 1], [2, 2]]");
    test("To Vec Vec", debug_show meet_and_greet.to_vec_vec([1, 2, 3]), "[[1, 2, 3], [2, 3, 4]]");

    test("Variant In", meet_and_greet.variant_in11(v1(1)), "#def");
    test("Variant In", meet_and_greet.variant_in12(v1(0), v1(2)), "#abc, #gh");
    test("Variant Array In", meet_and_greet.variant_array_in([v1(0), v1(1), v1(2)]), "#abc, #def, #gh");
    test("Variant Result Same In", meet_and_greet.variant_result_same_in(#ok(1)), "ok(1)");
    test("Variant Result Same In", meet_and_greet.variant_result_same_in(#err(2)), "err(2)");
    test("Variant String In", meet_and_greet.variant_string_in(#c("Hello")), "c(Hello)");
    test("Variant Result In", meet_and_greet.variant_result_in(#ok(1)), "ok(1)");
    test("Variant Result In", meet_and_greet.variant_result_in(#err("error")), "err(error)");
    test("Variant Array Result Same In", meet_and_greet.variant_array_result_same_in([#ok(1), #err(2)]), "ok(1), err(2)");
    test("Variant Array Result In", meet_and_greet.variant_array_result_in([#ok(1), #err("error")]), "ok(1), err(error)");

    test("Variant 11", debug_show meet_and_greet.variant11(#abc), "#def");
    test("Variant 12", debug_show meet_and_greet.variant12(#abc, #def), "#gh");
    test("Variant Array", debug_show meet_and_greet.variant_array([#abc, #def, #gh]), "[#def, #gh, #abc]");
    test("Variant Result Same", debug_show meet_and_greet.variant_result_same(#ok(1)), "#ok(2)");
    test("Variant Result", debug_show meet_and_greet.variant_result(#ok(1)), "#ok(2)");
    test("Variant Result", debug_show meet_and_greet.variant_result(#err("error")), "#err(\"error!\")");
    test("Variant String", debug_show meet_and_greet.variant_string(#c("hello")), "#c(\"hello!\")");
    test("Variant Array Result Same", debug_show meet_and_greet.variant_array_result_same([#ok(1), #err(2)]), "[#ok(2), #err(3)]");
    test("Variant Array Result", debug_show meet_and_greet.variant_array_result([#ok(1), #err("error")]), "[#ok(2), #err(\"error!\")]");

    test("Nested Variant 1 1", debug_show meet_and_greet.nested_variant1(#ok(#ok(#c("hello")))), "#ok(#ok(#c(\"hello!\")))");
    test("Nested Variant 1 2", debug_show meet_and_greet.nested_variant1(#ok(#err("error"))), "#ok(#err(\"error!\"))");
    test("Nested Variant 1 3", debug_show meet_and_greet.nested_variant1(#err(#abc)), "#err(#def)");

    test("Nested Variant 2 1", debug_show meet_and_greet.nested_variant2(#ok(#ok(#abc))), "#ok(#ok(#def))");
    test("Nested Variant 2 2", debug_show meet_and_greet.nested_variant2(#ok(#err("error"))), "#ok(#err(\"error!\"))");
    test("Nested Variant 2 3", debug_show meet_and_greet.nested_variant2(#err(#c("hello"))), "#err(#c(\"hello!\"))");

    // test("Option String", debug_show meet_and_greet.option_string(?("hello")), "?(\"hello!\")");
    // test("Options Array", debug_show meet_and_greet.options_array(?([?("hello"), null, ?("world")])), "?([?(\"hello!\"), null, ?(\"world!\")])");

    test("Tuple String U64", debug_show meet_and_greet.tuple_string_u64("hello", 1), "(\"hello!\", 2)");
    test("Tuple Variant Array Result", debug_show meet_and_greet.tuple_variant_array_result((#abc, ["hello", "world"], #ok(1))), "(#def, [\"hello!\", \"world!\"], #ok(2))");
    test("Tuples Nested1", debug_show meet_and_greet.tuples_nested1((true, (1, 2)), ((2, 3), 4)), "((false, 3), (3, 7))");
    test("Tuples Nested", debug_show meet_and_greet.tuples_nested((true, (1, 2)), ((2, 3), 4)), "((false, 3), (3, 7))");

    test("Unit", debug_show meet_and_greet.unit(), "()");
    test("Unit Result", debug_show meet_and_greet.unit_result(#ok), "#ok");
    test("Unit Result", debug_show meet_and_greet.unit_result(#err), "#ok");
    test("Unit Result Er", debug_show meet_and_greet.unit_result_er(#err("abc")), "#err(\"abc!\")");
    test("Unit Result Er", debug_show meet_and_greet.unit_result_er(#ok), "#ok");
    test("Unit Result Ok", debug_show meet_and_greet.unit_result_ok(#ok("abc")), "#ok(\"abc!\")");
    test("Unit Result Ok", debug_show meet_and_greet.unit_result_ok(#err), "#err");
};

if (failed > 0) {
    debugPrint("‚ùå Failed: " # debug_show (failed));
} else {
    debugPrint("‚úÖ All tests passed!");
};
