//MOC-FLAG --package core /home/alexuta/code/motoko-core/src/ --package bhttp-parser /home/alexuta/code/bhttp-parser/
import Prim "mo:prim";
import Blob "mo:core/Blob";
import { BHttpParser } "mo:bhttp-parser/parser";
import BHttpResponseBuilder "mo:bhttp-parser/response";
import Text "mo:core/Text";
import Array "mo:core/Array";

actor {

  func http_handler(b : [Nat8]) : [Nat8] {
    let parser = BHttpParser(b);
    let request = parser.parse();

    switch (request) {
      case (?request) {
        Prim.debugPrint("request: " # debug_show (request));
      };
      case (null) {
        Prim.debugPrint("error: Unsupported request.");
      };
    };

    let builder = BHttpResponseBuilder.new().withFraming(#RESPONSE_FIXED).withStatusCode(404).withHeaders([]).withBody(("blabla" : Blob).toArray());
    let response = builder.build();

    Prim.debugPrint(debug_show (response));

    response;
  };

  // http_request_v2
  public shared query ({ caller }) func http_request_v2(b : [Nat8]) : async [Nat8] {
    http_handler(b);
  };

  // http_request_update_v2
  public shared ({ caller }) func http_request_update_v2(b : Blob) : async Blob {
    Blob.fromArray(http_handler(b.toArray()));
  };

  public shared func test1(v : [Nat8]) : async [Nat8] {
    Prim.debugPrint("test1: " # debug_show (v));
    v;
  };

};

//SKIP run
//SKIP run-ir
//SKIP run-low
//ENHANCED-ORTHOGONAL-PERSISTENCE-ONLY
//MOC-NO-FORCE-GC

//CALL query http_request_v2 "\x00\x03\x47\x45\x54\x05\x68\x74\x74\x70\x73\x23\x61\x37\x68\x70\x73\x2d\x6d\x79\x61\x61\x61\x2d\x61\x61\x61\x61\x75\x2d\x61\x63\x75\x6e\x61\x2d\x63\x61\x69\x2e\x69\x63\x70\x33\x2e\x69\x6f\x0a\x2f\x61\x70\x69\x2f\x74\x6f\x64\x6f\x73\x26\x12\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x12\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x00\x00"
//CALL query http_request_v2 "\x00\x04\x50\x4f\x53\x54\x05\x68\x74\x74\x70\x73\x23\x61\x37\x68\x70\x73\x2d\x6d\x79\x61\x61\x61\x2d\x61\x61\x61\x61\x75\x2d\x61\x63\x75\x6e\x61\x2d\x63\x61\x69\x2e\x69\x63\x70\x33\x2e\x69\x6f\x0a\x2f\x61\x70\x69\x2f\x74\x6f\x64\x6f\x73\x40\x51\x0c\x63\x6f\x6e\x74\x65\x6e\x74\x2d\x74\x79\x70\x65\x10\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x6a\x73\x6f\x6e\x12\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x1f\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x2c\x63\x6f\x6e\x74\x65\x6e\x74\x2d\x74\x79\x70\x65\x10\x7b\x22\x74\x69\x74\x6c\x65\x22\x3a\x22\x74\x65\x73\x74\x22\x7d\x00"

//CALL ingress http_request_update_v2 "\x00\x03\x47\x45\x54\x05\x68\x74\x74\x70\x73\x23\x61\x37\x68\x70\x73\x2d\x6d\x79\x61\x61\x61\x2d\x61\x61\x61\x61\x75\x2d\x61\x63\x75\x6e\x61\x2d\x63\x61\x69\x2e\x69\x63\x70\x33\x2e\x69\x6f\x0a\x2f\x61\x70\x69\x2f\x74\x6f\x64\x6f\x73\x26\x12\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x12\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x00\x00"
//CALL ingress http_request_update_v2 "\x00\x04\x50\x4f\x53\x54\x05\x68\x74\x74\x70\x73\x23\x61\x37\x68\x70\x73\x2d\x6d\x79\x61\x61\x61\x2d\x61\x61\x61\x61\x75\x2d\x61\x63\x75\x6e\x61\x2d\x63\x61\x69\x2e\x69\x63\x70\x33\x2e\x69\x6f\x0a\x2f\x61\x70\x69\x2f\x74\x6f\x64\x6f\x73\x40\x51\x0c\x63\x6f\x6e\x74\x65\x6e\x74\x2d\x74\x79\x70\x65\x10\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x6a\x73\x6f\x6e\x12\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x1f\x69\x63\x2d\x69\x6e\x63\x6c\x75\x64\x65\x2d\x68\x65\x61\x64\x65\x72\x73\x2c\x63\x6f\x6e\x74\x65\x6e\x74\x2d\x74\x79\x70\x65\x10\x7b\x22\x74\x69\x74\x6c\x65\x22\x3a\x22\x74\x65\x73\x74\x22\x7d\x00"
