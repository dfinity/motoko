name: release

# We trigger this on all tags and on the `master` branch. The job
# `changelog` will fail for tags that don't have a
# changelog entry, so that seems good enough.
# For `master` this check is skipped as well as uploads.

on:
  push:
    tags:
    - '*'
    branches:
    - 'master'
  workflow_dispatch:
    # To test this workflow: Go to Actions -> release -> Run workflow
    # Or using the CLI: gh workflow run release --ref <branch>
    # This creates a draft release tagged 'test-draft-release' 
    # Remember to delete the draft release after testing!

jobs:
  # first check that the changelog is in good order and extract the changelog
  # This will fail for non-release tags.
  changelog:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Extract changelog
      id: read_changelog
      uses: ./.github/actions/extract-changelog
      with:
        version: ${{ github.ref_name }}
    outputs:
      release_body: ${{ steps.read_changelog.outputs.release_body }}

  release:
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-13, ubuntu-24.04-arm, macos-latest ]
    runs-on: ${{ matrix.os }}
    needs: changelog
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: experimental-features = nix-command flakes ca-derivations
    - uses: cachix/cachix-action@v16
      with:
        name: ic-hs-test
        # NB: No auth token, we donâ€™t expect to push new stuff here

    - name: Build platform-specific release files
      run: |
        nix build --max-jobs 1 '.#"release-files-${{ matrix.os }}"'

        echo "## checks"
        uname -s -m
        moc="$(nix build --max-jobs 1 .#release.moc --print-out-paths)"
        "$moc/bin/moc" --version
        file "$moc/bin/moc"
        ldd "$moc/bin/moc" || true

    - name: Upload Release Assets
      if: startsWith(github.ref, 'refs/tags/')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ github.ref }}
        file: result/*
        file_glob: true
        body: ${{ needs.changelog.outputs.release_body }}

    - name: Upload Draft Release Assets
      if: github.event_name == 'workflow_dispatch'
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        tag: 'test-draft-release'
        file: result/*
        file_glob: true
        body: 'Test draft release created via workflow dispatch'
        draft: true
        prerelease: true
    

