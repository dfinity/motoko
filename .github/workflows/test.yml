name: "build"
on:
  push:
    branches: [ master ]
  pull_request: {}

jobs:
  common-tests:
    strategy:
      matrix:
        os: [ ubuntu-latest, ubuntu-24.04-arm, macos-latest ]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Common Tests
        uses: ./.github/actions/test-blueprint
        with:
          os: ${{ matrix.os }}
          test-target: common-tests
          test-name: ${{ matrix.os }}-common-tests
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

  gc-tests:
    strategy:
      matrix:
        os: [ ubuntu-latest, ubuntu-24.04-arm, macos-latest ]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Run GC Tests
        uses: ./.github/actions/test-blueprint
        with:
          os: ${{ matrix.os }}
          test-target: gc-tests
          test-name: ${{ matrix.os }}-gc-tests
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

  tests:
    strategy:
      matrix:
        os: [ ubuntu-latest, ubuntu-24.04-arm, macos-latest ]
        build_type: [ release, debug ]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          # fetch full history so that git merge-base works
          fetch-depth: 0
          # fetch PR commit, not predicted merge commit
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Run Tests
        uses: ./.github/actions/test-blueprint
        with:
          os: ${{ matrix.os }}
          test-target: ${{ matrix.build_type }}-systems-go
          test-name: ${{ matrix.os }}-${{ matrix.build_type }}-tests
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Run Performance Tests
        if: github.actor != 'dependabot[bot]' && github.event_name == 'pull_request' && runner.os == 'Linux' && runner.arch == 'X64' && matrix.build_type == 'release'
        uses: ./.github/actions/performance
        with:
          head_sha: ${{ github.event.pull_request.head.sha }}
          head_ref: ${{ github.event.pull_request.head.ref }}
          base_ref: ${{ github.base_ref }}
          pr_number: ${{ github.event.pull_request.number }}
          is_fork: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
          niv_updater_token: ${{ secrets.NIV_UPDATER_TOKEN }}

  reports:
    if: github.ref == 'refs/heads/master'
    needs: [tests]
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
      - uses: cachix/cachix-action@v16
        with:
          name: ic-hs-test
      - name: Fetch report
        run: nix build .#report-site -o report-site
      - name: Resolve symlinks
        run: cp -rL report-site report-site-copy
      - name: Push report to GitHub pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: report-site-copy
          single-commit: true

  artifacts:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && contains(github.event.pull_request.labels.*.name, 'build_artifacts')
    strategy:
      matrix:
        os: [ ubuntu-latest, ubuntu-24.04-arm, macos-latest ]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
      - uses: cachix/cachix-action@v16
        with:
          name: ic-hs-test
      - name: nix-build
        run: |
          nix build .#release.moc
      # upload-artifact doesn't work for symlink dir
      # https://github.com/actions/upload-artifact/issues/92
      - run: echo "UPLOAD_PATH=$(readlink -f result)" >> $GITHUB_ENV
      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: moc-${{ matrix.os }}
          path: ${{ env.UPLOAD_PATH }}
          retention-days: 5

  verify-common-gc:
    needs: [common-tests, gc-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Common and GC tests passed
        run: echo "Common and GC tests completed successfully"

  verify-main-tests:
    needs: tests
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Main tests passed
        run: echo "Main tests completed successfully on ${{ matrix.os }}"

  # TODO: this is a temporary step:
  # - run only on push to master
  # - extract common from release.yml
  # Now build the release on both linux and darwin
  build:
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-13, ubuntu-24.04-arm, macos-latest ]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: experimental-features = nix-command flakes ca-derivations
    - uses: cachix/cachix-action@v16
      with:
        name: ic-hs-test
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: "nix-build"
      # these are the dependencies listed in release-files. Sorry for the duplication
      run: |
        cachix watch-exec ic-hs-test -- \
          nix build --max-jobs 1 -L \
            .#release.moc \
            .#release.mo-doc \
            .#js.moc \
            .#js.moc_interpreter

        echo "## checks"
        uname -s -m
        moc="$(nix build --max-jobs 1 .#release.moc --print-out-paths)"
        "$moc/bin/moc" --version
        file "$moc/bin/moc"
        ldd "$moc/bin/moc" || true

  # Finally do the upload. Hopefully the previous job has uploaded the
  # build product to the cachix cache, as we cannot build the darwin products on
  # linux
  release:
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-13, ubuntu-24.04-arm, macos-latest ]
    runs-on: ${{ matrix.os }}
    needs: [ build ]
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: experimental-features = nix-command flakes ca-derivations
    - uses: cachix/cachix-action@v16
      with:
        name: ic-hs-test
        # NB: No auth token, we donâ€™t expect to push new stuff here

    - name: Build platform-specific release files
      run: nix build --max-jobs 1 '.#"release-files-${{ matrix.os }}"'
