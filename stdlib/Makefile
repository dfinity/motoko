ASC=../src/asc
OUTDIR=_out
DOCDIR=doc
MDofAS=./markdown-of-actorscript.py
MDofMD=./markdown-of-markdown.py
PANDOC=pandoc

# Add new module targets here:
MODULES=\
	Hash \
	List \
	ListTest \
	AssocList \
	Trie \
	DocTable \
	Set \
	SetDb \
	SetDbTest \
	ProduceExchange \

WASM=\
  ProduceExchange

OUTFILES=$(addsuffix .out, $(MODULES)) $(addsuffix .wasm, $(WASM))

OUTPATHS=$(addprefix $(OUTDIR)/, $(OUTFILES))

.PHONY: default all clean alltests alldoc docMd docHtml

default: all

docmsg:
	@echo Begin building documentation in \`$(DOCDIR)\`...
	@echo $(HRULE)

alltests: $(OUTDIR) $(OUTPATHS)

all: alltests alldoc

alldoc: docMd docHtml

# Markdown documentation, extracted from the source directory
docMd: \
	$(DOCDIR)/README.md \
	$(DOCDIR)/prelude.md \
	$(DOCDIR)/hash.md \
	$(DOCDIR)/list.md \
	$(DOCDIR)/assocList.md \
	$(DOCDIR)/trie.md \
	$(DOCDIR)/docTable.md \
	$(DOCDIR)/set.md \
	$(DOCDIR)/setDb.md \
	$(DOCDIR)/setDbTest.md \
	$(DOCDIR)/examples/produce-exchange/README.md \
	$(DOCDIR)/examples/produce-exchange/serverTypes.md \
	$(DOCDIR)/examples/produce-exchange/serverActor.md \
	$(DOCDIR)/examples/produce-exchange/serverModelTypes.md \
	$(DOCDIR)/examples/produce-exchange/serverModel.md \
	| \
	$(DOCDIR)/ \
	$(DOCDIR)/examples/produce-exchange/

# HTML documentation, extracted from the source directory
docHtml: \
	$(DOCDIR)/README.html \
	$(DOCDIR)/prelude.html \
	$(DOCDIR)/hash.html \
	$(DOCDIR)/list.html \
	$(DOCDIR)/assocList.html \
	$(DOCDIR)/trie.html \
	$(DOCDIR)/docTable.html \
	$(DOCDIR)/set.html \
	$(DOCDIR)/setDb.html \
	$(DOCDIR)/setDbTest.html \
	$(DOCDIR)/examples/produce-exchange/README.html \
	$(DOCDIR)/examples/produce-exchange/serverTypes.html \
	$(DOCDIR)/examples/produce-exchange/serverActor.html \
	$(DOCDIR)/examples/produce-exchange/serverModelTypes.html \
	$(DOCDIR)/examples/produce-exchange/serverModel.html \
	| \
	$(DOCDIR)/ \
	$(DOCDIR)/examples/produce-exchange/

clean:
	rm -rf $(OUTDIR) $(DOCDIR)

$(OUTDIR):
	@mkdir $@

$(DOCDIR):
	mkdir $@

$(DOCDIR)/README.md: README.md | $(DOCDIR)
	@echo "<!-- **[ DO NOT EDIT -- GENERATED by a Makefile, on `date` ]** -->" > $@
	@echo "" >> $@
	$(MDofMD) $< >> $@

$(DOCDIR)/examples/produce-exchange/: README.md
	@mkdir -p $@

$(DOCDIR)/examples/produce-exchange/README.md: examples/produce-exchange/README.md | $(DOCDIR)/examples/produce-exchange/
	@echo "<!-- **[ DO NOT EDIT -- GENERATED by a Makefile, on `date` ]** -->" > $@
	@echo "" >> $@
	$(MDofMD) $< >> $@

$(OUTDIR)/Hash.out: hash.as | $(OUTDIR)
	$(ASC) -r hash.as > $@

$(OUTDIR)/List.out: list.as | $(OUTDIR)
	$(ASC) -r list.as > $@

$(OUTDIR)/ListTest.out: list.as listTest.as | $(OUTDIR)
	$(ASC) -r listTest.as > $@

$(OUTDIR)/AssocList.out: list.as assocList.as | $(OUTDIR)
	$(ASC) -r assocList.as > $@

$(OUTDIR)/Trie.out: prelude.as hash.as list.as assocList.as trie.as | $(OUTDIR)
	$(ASC) -r trie.as > $@

$(OUTDIR)/DocTable.out: prelude.as hash.as list.as assocList.as trie.as docTable.as | $(OUTDIR)
	$(ASC) -r docTable.as > $@

$(OUTDIR)/Set.out: prelude.as hash.as list.as assocList.as trie.as set.as | $(OUTDIR)
	$(ASC) -r set.as > $@

$(OUTDIR)/SetDb.out: prelude.as hash.as list.as assocList.as trie.as set.as setDb.as | $(OUTDIR)
	$(ASC) -r setDb.as > $@

$(OUTDIR)/SetDbTest.out: prelude.as hash.as list.as assocList.as trie.as set.as setDb.as setDbTest.as | $(OUTDIR)
	$(ASC) -r setDbTest.as > $@

PRODUCE_EXCHANGE_SRC=\
	prelude.as hash.as list.as assocList.as trie.as docTable.as \
	examples/produce-exchange/serverTypes.as \
	examples/produce-exchange/serverModelTypes.as \
	examples/produce-exchange/serverModel.as \
	examples/produce-exchange/serverActor.as \

$(OUTDIR)/ProduceExchange.out: $(PRODUCE_EXCHANGE_SRC) \
	examples/produce-exchange/test/simpleSetupAndQuery.as | $(OUTDIR)
	$(ASC) -r examples/produce-exchange/test/simpleSetupAndQuery.as > $@

$(OUTDIR)/ProduceExchange.wasm: $(PRODUCE_EXCHANGE_SRC) | $(OUTDIR)
	$(ASC) -c --dfinity -o $@ examples/produce-exchange/serverActor.as

$(DOCDIR)/%.md: %.as $(MDofAS) | $(DOCDIR)
	@echo "<!-- **[ Do not edit; This file was machine-generated on `date`. ]** -->" > $@
	@echo "" >> $@
	@echo "" >> $@
	$(MDofAS) $< >> $@

$(DOCDIR)/%.html: $(DOCDIR)/%.md
	$(PANDOC) -f gfm $^ > $@
