<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>tailcall.ml &mdash; Coverage report</title>
    <meta name="description" content="91.00% coverage in ir_passes/tailcall.ml">
    <link rel="stylesheet" href="../coverage.css"/>
    <script src="../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">ir_passes/</span>tailcall.ml
        </a>
      </h1>
      <h2>91.00%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:21.74%"></span>
      <span class="unvisited" style="top:27.17%"></span>
      <span class="some-visited" style="top:33.33%"></span>
      <span class="unvisited" style="top:39.49%"></span>
      <span class="unvisited" style="top:41.30%"></span>
      <span class="unvisited" style="top:47.10%"></span>
      <span class="unvisited" style="top:47.83%"></span>
      <span class="unvisited" style="top:48.19%"></span>
      <span class="unvisited" style="bottom:6.16%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span > </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span > </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span class="visited"> </span>
<a id="L60"></a><span class="unvisited"> </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span class="visited"> </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span class="visited"> </span>
<a id="L66"></a><span class="visited"> </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span class="visited"> </span>
<a id="L73"></a><span class="visited"> </span>
<a id="L74"></a><span class="visited"> </span>
<a id="L75"></a><span class="unvisited"> </span>
<a id="L76"></a><span > </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span class="visited"> </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span class="visited"> </span>
<a id="L88"></a><span class="visited"> </span>
<a id="L89"></a><span class="visited"> </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span class="visited"> </span>
<a id="L92"></a><span class="some-visited"> </span>
<a id="L93"></a><span > </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span class="visited"> </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span > </span>
<a id="L101"></a><span class="visited"> </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span class="visited"> </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span class="visited"> </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span class="visited"> </span>
<a id="L109"></a><span class="unvisited"> </span>
<a id="L110"></a><span class="visited"> </span>
<a id="L111"></a><span class="visited"> </span>
<a id="L112"></a><span class="visited"> </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span class="unvisited"> </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span class="visited"> </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span class="visited"> </span>
<a id="L122"></a><span class="visited"> </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span class="unvisited"> </span>
<a id="L131"></a><span > </span>
<a id="L132"></a><span class="unvisited"> </span>
<a id="L133"></a><span class="unvisited"> </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span class="visited"> </span>
<a id="L136"></a><span > </span>
<a id="L137"></a><span class="visited"> </span>
<a id="L138"></a><span > </span>
<a id="L139"></a><span class="visited"> </span>
<a id="L140"></a><span class="visited"> </span>
<a id="L141"></a><span class="visited"> </span>
<a id="L142"></a><span class="visited"> </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span > </span>
<a id="L148"></a><span class="visited"> </span>
<a id="L149"></a><span class="visited"> </span>
<a id="L150"></a><span > </span>
<a id="L151"></a><span > </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span class="visited"> </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span class="visited"> </span>
<a id="L156"></a><span class="visited"> </span>
<a id="L157"></a><span class="visited"> </span>
<a id="L158"></a><span class="visited"> </span>
<a id="L159"></a><span class="visited"> </span>
<a id="L160"></a><span > </span>
<a id="L161"></a><span > </span>
<a id="L162"></a><span class="visited"> </span>
<a id="L163"></a><span class="visited"> </span>
<a id="L164"></a><span class="visited"> </span>
<a id="L165"></a><span > </span>
<a id="L166"></a><span class="visited"> </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span > </span>
<a id="L169"></a><span class="visited"> </span>
<a id="L170"></a><span > </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span class="visited"> </span>
<a id="L173"></a><span class="visited"> </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span class="visited"> </span>
<a id="L177"></a><span > </span>
<a id="L178"></a><span > </span>
<a id="L179"></a><span class="visited"> </span>
<a id="L180"></a><span class="visited"> </span>
<a id="L181"></a><span > </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span class="visited"> </span>
<a id="L184"></a><span > </span>
<a id="L185"></a><span > </span>
<a id="L186"></a><span class="visited"> </span>
<a id="L187"></a><span > </span>
<a id="L188"></a><span > </span>
<a id="L189"></a><span class="visited"> </span>
<a id="L190"></a><span class="visited"> </span>
<a id="L191"></a><span class="visited"> </span>
<a id="L192"></a><span class="visited"> </span>
<a id="L193"></a><span > </span>
<a id="L194"></a><span > </span>
<a id="L195"></a><span > </span>
<a id="L196"></a><span > </span>
<a id="L197"></a><span > </span>
<a id="L198"></a><span > </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span > </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span class="visited"> </span>
<a id="L203"></a><span class="visited"> </span>
<a id="L204"></a><span class="visited"> </span>
<a id="L205"></a><span class="visited"> </span>
<a id="L206"></a><span class="visited"> </span>
<a id="L207"></a><span > </span>
<a id="L208"></a><span > </span>
<a id="L209"></a><span > </span>
<a id="L210"></a><span > </span>
<a id="L211"></a><span class="visited"> </span>
<a id="L212"></a><span class="visited"> </span>
<a id="L213"></a><span class="visited"> </span>
<a id="L214"></a><span class="visited"> </span>
<a id="L215"></a><span class="visited"> </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span > </span>
<a id="L218"></a><span > </span>
<a id="L219"></a><span class="visited"> </span>
<a id="L220"></a><span > </span>
<a id="L221"></a><span class="visited"> </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span > </span>
<a id="L224"></a><span class="visited"> </span>
<a id="L225"></a><span > </span>
<a id="L226"></a><span class="visited"> </span>
<a id="L227"></a><span > </span>
<a id="L228"></a><span class="visited"> </span>
<a id="L229"></a><span > </span>
<a id="L230"></a><span class="visited"> </span>
<a id="L231"></a><span > </span>
<a id="L232"></a><span class="visited"> </span>
<a id="L233"></a><span > </span>
<a id="L234"></a><span class="visited"> </span>
<a id="L235"></a><span > </span>
<a id="L236"></a><span > </span>
<a id="L237"></a><span > </span>
<a id="L238"></a><span class="visited"> </span>
<a id="L239"></a><span class="visited"> </span>
<a id="L240"></a><span class="visited"> </span>
<a id="L241"></a><span class="visited"> </span>
<a id="L242"></a><span > </span>
<a id="L243"></a><span class="visited"> </span>
<a id="L244"></a><span class="visited"> </span>
<a id="L245"></a><span > </span>
<a id="L246"></a><span > </span>
<a id="L247"></a><span class="visited"> </span>
<a id="L248"></a><span class="visited"> </span>
<a id="L249"></a><span > </span>
<a id="L250"></a><span class="visited"> </span>
<a id="L251"></a><span class="visited"> </span>
<a id="L252"></a><span > </span>
<a id="L253"></a><span > </span>
<a id="L254"></a><span > </span>
<a id="L255"></a><span class="visited"> </span>
<a id="L256"></a><span class="visited"> </span>
<a id="L257"></a><span > </span>
<a id="L258"></a><span > </span>
<a id="L259"></a><span class="unvisited"> </span>
<a id="L260"></a><span class="visited"> </span>
<a id="L261"></a><span class="visited"> </span>
<a id="L262"></a><span > </span>
<a id="L263"></a><span > </span>
<a id="L264"></a><span class="visited"> </span>
<a id="L265"></a><span class="visited"> </span>
<a id="L266"></a><span class="visited"> </span>
<a id="L267"></a><span > </span>
<a id="L268"></a><span class="visited"> </span>
<a id="L269"></a><span > </span>
<a id="L270"></a><span > </span>
<a id="L271"></a><span class="visited"> </span>
<a id="L272"></a><span class="visited"> </span>
<a id="L273"></a><span > </span>
<a id="L274"></a><span > </span>
<a id="L275"></a><span > </span>
<a id="L276"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
<a href="#L254">254</a>
<a href="#L255">255</a>
<a href="#L256">256</a>
<a href="#L257">257</a>
<a href="#L258">258</a>
<a href="#L259">259</a>
<a href="#L260">260</a>
<a href="#L261">261</a>
<a href="#L262">262</a>
<a href="#L263">263</a>
<a href="#L264">264</a>
<a href="#L265">265</a>
<a href="#L266">266</a>
<a href="#L267">267</a>
<a href="#L268">268</a>
<a href="#L269">269</a>
<a href="#L270">270</a>
<a href="#L271">271</a>
<a href="#L272">272</a>
<a href="#L273">273</a>
<a href="#L274">274</a>
<a href="#L275">275</a>
<a href="#L276">276</a>
</pre>
<pre><code class="ocaml">open Ir_def
open Mo_types

open Source
open Ir
open Ir_effect
open Type
open Construct

(* Optimize (self) tail calls to jumps, avoiding stack overflow
   in a single linear pass *)

(*
This is simple tail call optimizer that replaces tail calls to the current function by jumps.
It can  easily be extended to non-self tail calls, once supported by wasm.

For each function `f` whose `body[...]` has at least one self tailcall to `f&lt;Ts&gt;(es)`, apply the transformation:
```
    func f&lt;Ts&gt;(pat) = body[f&lt;Ts&gt;(es)+]
    ~~&gt;
    func f&lt;Ts&gt;(args) = {
       var temp = args;
       loop {
         label l {
           let pat = temp;
           return body[{temp := es;break l;}+]
        }
      }
    }
```


It's implemented by a recursive traversal that maintains an environment recording whether the current term is in tail position,
and what its enclosing function (if any) is.

The enclosing function is forgotten when shadowed by a local binding (we don't assume all variables are distinct) and when
entering a function, class or actor constructor.

On little gotcha for functional programmers: the argument `e` to an early `return e` is *always* in tail position,
regardless of `return e`s own tail position.

TODO: optimize for multiple arguments using multiple temps (not a tuple).

*)

type func_info = { func: id;
                   typ_binds: typ_bind list;
                   temps: var list;
                   label: id;
                   tail_called: bool ref;
                 }

type env = { tail_pos:bool;          (* is the expression in tail position *)
             info: func_info option; (* the innermost enclosing func, if any *)
           }


let bind env i (info:func_info option) : env =
  <span data-count="773353">m</span>atch info with
  | <span data-count="0">S</span>ome _ -&gt;
    { env with info = info; }
  | <span data-count="773353">N</span>one -&gt;
    match env.info with
    | <span data-count="452499">S</span>ome { func; _} when i = func -&gt;
      <span data-count="13">{</span> env with info = None } (* remove shadowed func info *)
    | <span data-count="773340">_</span> -&gt; env (* preserve existing, non-shadowed info *)

let bind_arg env a info = <span data-count="244442">b</span>ind env a.it info


let are_generic_insts (tbs : typ_bind list) insts =
  <span data-count="1663">L</span>ist.for_all2 (fun (tb : typ_bind) inst -&gt;
      <span data-count="90">m</span>atch inst with
      | <span data-count="90">C</span>on(c2,[]) -&gt; Cons.eq tb.it.con c2 (* conservative, but safe *)
      |  <span data-count="0">_</span> -&gt; false
      ) tbs insts

let rec tailexp env e =
  <span data-count="627924">{</span>e with it = exp<span data-count="627924">'</span> env e}

and exp env e  : exp =
  <span data-count="1604176">{</span>e with it = exp<span data-count="1604176">'</span> {env with tail_pos = false}  e}

and assignEs vars exp : dec list =
  <span data-count="1654">m</span>atch vars, exp.it with
  | <span data-count="1424">[</span>v], _ -&gt; [ exp<span data-count="1424">D</span> (assign<span data-count="1424">E</span> v exp) ]
  | <span data-count="124">_</span>, PrimE (TupPrim, es) when List.lengt<span data-count="124">h</span> es = List.lengt<span data-count="124">h</span> vars -&gt;
       <span data-count="124">L</span>ist.map expD (List.map<span data-count="124">2</span> assignE vars es)
  | <span data-count="106">_</span>, _ -&gt;
    let tup = fresh_var "tup" (ty<span data-count="106">p</span> exp) in
    <span data-count="106">l</span>et<span data-count="106">D</span> tup exp ::
    List.map<span data-count="106">i</span> (fun i v -&gt; <span data-count="0">e</span>xpD (assign<span data-count="0">E</span> v (proj<span data-count="0">E</span> (var<span data-count="0">E</span> v) i))) vars

and exp' env e  : exp' = <span data-count="2232100">m</span>atch e.it with
  | (<span data-count="787728">V</span>arE (_, _) | <span data-count="181067">L</span>itE _) as it -&gt; it
  | <span data-count="49610">A</span>ssignE (e1, e2)    -&gt; AssignE (lex<span data-count="49610">p</span> env e1, ex<span data-count="49610">p</span> env e2)
  | <span data-count="171084">P</span>rimE (CallPrim insts, [e1; e2])  -&gt;
    begin match e1.it, env with
    | <span data-count="25892">V</span>arE (_, f1), { tail_pos = true;
                      info = Some { func; typ_binds; temps; label; tail_called } }
         when f1 = func &amp;&amp; <span data-count="1663">a</span>re_generic_inst<span data-count="1663">s</span> typ_binds insts  -&gt;
      <span data-count="1654">t</span>ail_called := true;
      (block<span data-count="1654">E</span> (assignE<span data-count="1654">s</span> temps (ex<span data-count="1654">p</span> env e2)) (break<span data-count="1654">E</span> label (unit<span data-count="1654">E</span> ()))).it
    | <span data-count="169430">_</span>,_-&gt; PrimE (CallPrim insts, [ex<span data-count="169430">p</span> env e1; ex<span data-count="169430">p</span> env e2])
    end
  | <span data-count="184546">B</span>lockE (ds, e)      -&gt; BlockE (bloc<span data-count="184546">k</span> env ds e)
  | <span data-count="56685">I</span>fE (e1, e2, e3)    -&gt; IfE (ex<span data-count="56685">p</span> env e1, tailex<span data-count="56685">p</span> env e2, tailex<span data-count="56685">p</span> env e3)
  | <span data-count="31190">S</span>witchE (e, cs)     -&gt; SwitchE (ex<span data-count="31190">p</span> env e, case<span data-count="31190">s</span> env cs)
  | <span data-count="0">T</span>ryE (e, cs, vt)    -&gt; TryE (ex<span data-count="0">p</span> env e, case<span data-count="0">s</span> env cs, vt) (* TBR *)
  | <span data-count="8772">L</span>oopE e1            -&gt; LoopE (ex<span data-count="8772">p</span> env e1)
  | <span data-count="8500">L</span>abelE (i, t, e)    -&gt; let env1 = bind env i None in
                           <span data-count="8500">L</span>abelE(i, t, ex<span data-count="8500">p</span> env1 e)
  | <span data-count="15950">P</span>rimE (RetPrim, [e])-&gt; PrimE (RetPrim, [tailex<span data-count="15950">p</span> { env with tail_pos = true } e])
  | <span data-count="0">A</span>syncE (s, tb, e, typ) -&gt; AsyncE (s, tb, ex<span data-count="0">p</span> { tail_pos = true; info = None } e, typ)
  | <span data-count="17006">D</span>eclareE (i, t, e)  -&gt; let env1 = bind env i None in
                           <span data-count="17006">D</span>eclareE (i, t, tailex<span data-count="17006">p</span> env1 e)
  | <span data-count="17006">D</span>efineE (i, m, e)   -&gt; DefineE (i, m, ex<span data-count="17006">p</span> env e)
  | <span data-count="48120">F</span>uncE (x, s, c, tbs, as_, ret_tys, exp0) -&gt;
    let env1 = { tail_pos = true; info = None} in
    let env2 = args env1 as_ in
    <span data-count="48120">l</span>et exp0' = tailexp env2 exp0 in
    <span data-count="48120">F</span>uncE (x, s, c, tbs, as_, ret_tys, exp0')
  | <span data-count="6910">S</span>elfCallE (ts, exp1, exp2, exp3, exp4) -&gt;
    let env1 = { tail_pos = true; info = None} in
    let exp1' = tailexp env1 exp1 in
    <span data-count="6910">l</span>et exp2' = exp env exp2 in
    <span data-count="6910">l</span>et exp3' = exp env exp3 in
    <span data-count="6910">l</span>et exp4' = exp env exp4 in
    <span data-count="6910">S</span>elfCallE (ts, exp1', exp2', exp3', exp4')
  | <span data-count="0">A</span>ctorE (ds, fs, u, t) -&gt;
    (* TODO: tco other upgrade fields? *)
    let u = { u with preupgrade = ex<span data-count="0">p</span> env u.preupgrade; postupgrade = ex<span data-count="0">p</span> env u.postupgrade; stable_record = ex<span data-count="0">p</span> env u.stable_record } in
    ActorE (sn<span data-count="0">d</span> (dec<span data-count="0">s</span> env ds), fs, u, t)
  | <span data-count="25387">N</span>ewObjE (s,is,t)    -&gt; NewObjE (s, is, t)
  | <span data-count="622539">P</span>rimE (p, es)       -&gt; PrimE (p, List.ma<span data-count="622539">p</span> (ex<span data-count="622539">p</span> env) es)

and lexp env le : lexp = <span data-count="49612">{</span>le with it = lexp<span data-count="49612">'</span> env le}

and lexp' env le : lexp' = <span data-count="49612">m</span>atch le.it with
  | <span data-count="45204">V</span>arLE i -&gt; VarLE i
  | <span data-count="409">D</span>otLE (e, sn)  -&gt; DotLE (ex<span data-count="409">p</span> env e, sn)
  | <span data-count="3999">I</span>dxLE (e1, e2) -&gt; IdxLE (ex<span data-count="3999">p</span> env e1, ex<span data-count="3999">p</span> env e2)

and args env as_ =
  <span data-count="224390">L</span>ist.fold_left (fun env a -&gt; <span data-count="244442">b</span>ind_arg env a None) env as_

and pat env p =
  <span data-count="501055">l</span>et env = pat' env p.it in
  <span data-count="501055">e</span>nv

and pat' env = function
  | <span data-count="107199">W</span>ildP
  | <span data-count="25727">L</span>itP _         -&gt; env
  | <span data-count="300215">V</span>arP i         -&gt; bind env i None
  | <span data-count="19775">T</span>upP ps        -&gt; pats env ps
  | <span data-count="4438">O</span>bjP pfs       -&gt; pats env (pats_of_obj_pa<span data-count="4438">t</span> pfs)
  | <span data-count="25789">O</span>ptP p
  | <span data-count="15080">T</span>agP (_, p)    -&gt; pat env p
  | <span data-count="2832">A</span>ltP (p1, _p2) -&gt; pat env p1 (* both bind the same vars, ensured in check_pat *)

and pats env ps  =
  <span data-count="100984">m</span>atch ps with
  | <span data-count="24213">[</span>] -&gt; env
  | <span data-count="76771">p</span> :: ps -&gt;
    let env1 = pat env p in
    <span data-count="76771">p</span>ats env1 ps

and case env (c : case) =
  <span data-count="65752">{</span> c with it = case<span data-count="65752">'</span> env c.it }
and case' env {pat=p;exp=e} =
  <span data-count="65752">l</span>et env1 = pat env p in
  <span data-count="65752">l</span>et e' = tailexp env1 e in
  <span data-count="65752">{</span> pat=p; exp=e' }


and cases env cs = <span data-count="31190">L</span>ist.map (cas<span data-count="31190">e</span> env) cs

and dec env d =
  <span data-count="518021">l</span>et (mk_d,env1) = dec' env d in
  <span data-count="518021">(</span>{d with it = mk_d}, env1)

and dec' env d =
  <span data-count="518021">m</span>atch d.it with
  (* A local let bound function, this is what we are looking for *)
  (* TODO: Do we need to detect more? A tuple of functions? *)
  | <span data-count="176270">L</span>etD (({it = VarP id;_} as id_pat),
          ({it = FuncE (x, Local, c, tbs, as_, typT, exp0);_} as funexp)) -&gt;
    let env = bind env id None in
    <span data-count="176270">b</span>egin fun env1 -&gt;
      <span data-count="176270">l</span>et temps = fresh_vars "temp" (List.ma<span data-count="176270">p</span> (fun a -&gt; <span data-count="197873">M</span>ut a.note) as_) in
      <span data-count="176270">l</span>et label = fresh_id "tailcall" () in
      <span data-count="176270">l</span>et tail_called = ref false in
      let env2 = { tail_pos = true;
                   info = Some { func = id;
                                 typ_binds = tbs;
                                 temps;
                                 label;
                                 tail_called } }
      in
      let env3 = args env2 as_ in (* shadow id if necessary *)
      <span data-count="176270">l</span>et exp0' = tailexp env3 exp0 in
      <span data-count="176270">l</span>et cs = List.map (fun (tb : typ_bind) -&gt; <span data-count="25787">C</span>on (tb.it.con, [])) tbs in
      <span data-count="176270">i</span>f !tail_called then
        <span data-count="1605">l</span>et ids = match typ funexp with
          | <span data-count="1605">F</span>unc( _, _, _, dom, _) -&gt;
            fresh_var<span data-count="1605">s</span> "id" (List.ma<span data-count="1605">p</span> (fun t -&gt; <span data-count="1645">o</span>pen_ cs t) dom)
          | _ -&gt; assert false
        in
        let l_typ = Type.unit in
        let body =
          blockE (List.map<span data-count="1605">2</span> (fun t i -&gt; <span data-count="1645">v</span>arD t (var<span data-count="1645">E</span> i)) temps ids) (
            loop<span data-count="1605">E</span> (
              label<span data-count="1605">E</span> label l_typ (block<span data-count="1605">E</span>
                (List.map<span data-count="1605">2</span> (fun a t -&gt; <span data-count="1645">l</span>etD (var_of_ar<span data-count="1645">g</span> a) (immute<span data-count="1645">E</span> (var<span data-count="1645">E</span> t))) as_ temps)
                (ret<span data-count="1605">E</span> exp0'))
            )
          )
        in
        <span data-count="1605">L</span>etD (id_pat, {funexp with it = FuncE (x, Local, c, tbs, List.ma<span data-count="1605">p</span> arg_of_var ids, typT, body)})
      else
        <span data-count="174665">L</span>etD (id_pat, {funexp with it = FuncE (x, Local, c, tbs, as_, typT, exp0')})
    end,
    env
  | <span data-count="314831">L</span>etD (p, e) -&gt;
    let env = pat env p in
    <span data-count="314831">(</span>fun env1 -&gt; <span data-count="314831">L</span>etD(p,ex<span data-count="314831">p</span> env1 e)),
    env
  | <span data-count="26918">V</span>arD (i, t, e) -&gt;
    let env = bind env i None in
    <span data-count="26918">(</span>fun env1 -&gt; <span data-count="26918">V</span>arD(i, t, ex<span data-count="26918">p</span> env1 e)),
    env
  | <span data-count="2">R</span>efD (i, t, e) -&gt;
    let env = bind env i None in
    <span data-count="2">(</span>fun env1 -&gt; <span data-count="2">R</span>efD(i, t, lex<span data-count="2">p</span> env1 e)),
    env

and decs env ds =
  <span data-count="185243">l</span>et rec decs_aux env ds =
    <span data-count="703264">m</span>atch ds with
    | <span data-count="185243">[</span>] -&gt; ([],env)
    | <span data-count="518021">d</span>::ds -&gt;
      let (mk_d, env1) = dec env d in
      <span data-count="518021">l</span>et (mk_ds, env2) = decs_aux env1 ds in
      <span data-count="518021">(</span>mk_d :: mk_ds,env2)
  in
  let mk_ds,env1 = decs_aux env ds in
  <span data-count="185243">e</span>nv1,
  List.ma<span data-count="185243">p</span>
    (fun mk_d -&gt;
      <span data-count="518021">l</span>et env2 = { env1 with tail_pos = false } in
      { mk_d with it = mk_d.i<span data-count="518021">t</span> env2 })
    mk_ds

and block env ds exp =
  <span data-count="184546">l</span>et (env1, ds') = decs env ds in
  <span data-count="184546">(</span> ds', tailex<span data-count="184546">p</span> env1 exp)

and comp_unit env = function
  | <span data-count="0">L</span>ibU _ -&gt; raise (Invalid_argument "cannot compile library")
  | <span data-count="358">P</span>rogU ds -&gt; ProgU (sn<span data-count="358">d</span> (dec<span data-count="358">s</span> env ds))
  | <span data-count="339">A</span>ctorU (as_opt, ds, fs, u, t)  -&gt;
    (* TODO: tco other fields of u? *)
    let u = { u with
              preupgrade = ex<span data-count="339">p</span> env u.preupgrade;
              postupgrade = ex<span data-count="339">p</span> env u.postupgrade;
              stable_record = ex<span data-count="339">p</span> env u.stable_record;
            } in
    ActorU (as_opt, sn<span data-count="339">d</span> (dec<span data-count="339">s</span> env ds), fs, u, t)

and prog (cu, flavor) =
  <span data-count="697">l</span>et env = { tail_pos = false; info = None } in
  (comp_uni<span data-count="697">t</span> env cu, flavor)

(* validation *)

let transform = prog
</code></pre>
      </div>
    </div>
    <script src="../coverage.js"></script>
  </body>
</html>
