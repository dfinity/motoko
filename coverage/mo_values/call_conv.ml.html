<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>call_conv.ml &mdash; Coverage report</title>
    <meta name="description" content="37.50% coverage in mo_values/call_conv.ml">
    <link rel="stylesheet" href="../coverage.css"/>
    <script src="../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">mo_values/</span>call_conv.ml
        </a>
      </h1>
      <h2>37.50%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="bottom:47.37%"></span>
      <span class="unvisited" style="bottom:42.11%"></span>
      <span class="unvisited" style="bottom:26.32%"></span>
      <span class="unvisited" style="bottom:21.05%"></span>
      <span class="unvisited" style="bottom:13.16%"></span>
      <span class="unvisited" style="bottom:10.53%"></span>
      <span class="unvisited" style="bottom:5.26%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span class="visited"> </span>
<a id="L20"></a><span class="unvisited"> </span>
<a id="L21"></a><span class="visited"> </span>
<a id="L22"></a><span class="unvisited"> </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span class="visited"> </span>
<a id="L26"></a><span class="visited"> </span>
<a id="L27"></a><span class="visited"> </span>
<a id="L28"></a><span class="unvisited"> </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span class="unvisited"> </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span class="unvisited"> </span>
<a id="L34"></a><span class="unvisited"> </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span class="unvisited"> </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1"> 1</a>
<a href="#L2"> 2</a>
<a href="#L3"> 3</a>
<a href="#L4"> 4</a>
<a href="#L5"> 5</a>
<a href="#L6"> 6</a>
<a href="#L7"> 7</a>
<a href="#L8"> 8</a>
<a href="#L9"> 9</a>
<a href="#L10">10</a>
<a href="#L11">11</a>
<a href="#L12">12</a>
<a href="#L13">13</a>
<a href="#L14">14</a>
<a href="#L15">15</a>
<a href="#L16">16</a>
<a href="#L17">17</a>
<a href="#L18">18</a>
<a href="#L19">19</a>
<a href="#L20">20</a>
<a href="#L21">21</a>
<a href="#L22">22</a>
<a href="#L23">23</a>
<a href="#L24">24</a>
<a href="#L25">25</a>
<a href="#L26">26</a>
<a href="#L27">27</a>
<a href="#L28">28</a>
<a href="#L29">29</a>
<a href="#L30">30</a>
<a href="#L31">31</a>
<a href="#L32">32</a>
<a href="#L33">33</a>
<a href="#L34">34</a>
<a href="#L35">35</a>
<a href="#L36">36</a>
<a href="#L37">37</a>
<a href="#L38">38</a>
</pre>
<pre><code class="ocaml">open Mo_types
open Type

(*
Functions of different arities (even if the look like they have the same type)
are not compatible, but the interpreters just pass tuples to them. In order to
still catch mismatching arities in the interpreter, we tag function values
with their “calling convention”, and check them in calls.
*)

type call_conv = {
  sort: func_sort;
  control : control;
  n_args : int;
  n_res : int;
}
type t = call_conv

let local_cc n m = <span data-count="3">{</span> sort = Local; control = Returns; n_args = n; n_res = m}
let message_cc s n = <span data-count="0">{</span> sort = Shared s; control = Returns; n_args = n; n_res = 0}
let async_cc s n m = <span data-count="1819">{</span> sort = Shared s; control = Promises; n_args = n; n_res = m}
let replies_cc s n m = <span data-count="0">{</span> sort = Shared s; control = Replies; n_args = n; n_res = m}

let call_conv_of_typ typ =
  <span data-count="122584">m</span>atch promote typ with
  | <span data-count="122584">F</span>unc (sort, control, tbds, dom, res) -&gt;
    { sort; control; n_args = List.lengt<span data-count="122584">h</span> dom; n_res = List.lengt<span data-count="122584">h</span> res }
  | <span data-count="0">N</span>on -&gt;
    { sort = Local; control = Returns; n_args = 1; n_res = 1 }
  | <span data-count="0">_</span> -&gt; raise (Invalid_argument ("call_conv_of_typ " ^ string_of_ty<span data-count="0">p</span> typ))

let string_of_call_conv {sort;control;n_args;n_res} =
  <span data-count="0">P</span>rintf.sprintf "(%s%i %s %i)"
    (string_of_func_sor<span data-count="0">t</span> sort)
    n_args
    (match control with <span data-count="0">R</span>eturns -&gt; "-&gt;" | <span data-count="0">P</span>romises -&gt; "@&gt;" | <span data-count="0">R</span>eplies -&gt; "#&gt;")
    n_res

</code></pre>
      </div>
    </div>
    <script src="../coverage.js"></script>
  </body>
</html>
